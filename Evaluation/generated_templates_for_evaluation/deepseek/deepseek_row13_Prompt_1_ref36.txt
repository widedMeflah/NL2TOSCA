tosca_definitions_version: tosca_simple_yaml_1_0

topology_template:
  description: Virtual Computing Environment with Autoscaling and Web Interface

  input_parameters:
    management_cpus:
      type: integer
      default: 2
    management_memory:
      type: string
      default: 4 GB
    worker_cpus:
      type: integer
      default: 1
    worker_memory:
      type: string
      default: 2 GB
    max_workers:
      type: integer
      default: 5
    admin_email:
      type: string
    api_key:
      type: string
    software_version:
      type: string
    description:
      type: string
    ssh_public_key:
      type: string

  node_templates:
    management_node:
      type: tosca.nodes.Compute
      properties:
        cpu:
          num_cpus: { get_input: management_cpus }
        memory:
          size: { get_input: management_memory }
        os:
          type: Linux
          distribution: Ubuntu
          version: 20.04

    worker_node:
      type: tosca.nodes.Compute
      properties:
        cpu:
          num_cpus: { get_input: worker_cpus }
        memory:
          size: { get_input: worker_memory }
        os:
          type: Linux
          distribution: Ubuntu
          version: 20.04

    web_interface:
      type: tosca.nodes.WebInterface
      properties:
        url: { get_output: web_url }
        admin_email: { get_input: admin_email }
        api_key: { get_input: api_key }
        software_version: { get_input: software_version }
        description: { get_input: description }
        ssh_public_key: { get_input: ssh_public_key }

    autoscaling_policy:
      type: tosca.policies.Scaling
      targets:
        - worker_node
      policies:
        - type: tosca.policies.Scaling.InOrOut
          properties:
            min_instances: 1
            max_instances: { get_input: max_workers }
            scaling_step: 1

  outputs:
    web_url:
      value: { get_attribute: [web_interface, url] }
    cluster_ip:
      value: { get_attribute: [management_node, public_address] }
    credentials:
      admin_email: { get_input: admin_email }
      api_key: { get_input: api_key }
      ssh_public_key: { get_input: ssh_public_key }
