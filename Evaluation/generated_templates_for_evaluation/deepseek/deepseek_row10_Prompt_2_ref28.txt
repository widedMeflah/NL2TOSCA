
tosca_definitions_version: tosca_simple_yaml_1_0

topology_template:
  description: Elasticsearch VM Setup
  node_templates:
    VirtualMachine:
      type: tosca.nodes.Compute
      properties:
        cpu:
          constraints: [2, 4]
          default: 2
        memory:
          constraints: [4, 8]
          default: 4
      capabilities:
        endpoint:
          properties:
            network_name: public
            public: true
            ports:
              - 9200
              - 5601

    Elasticsearch:
      type: tosca.nodes.SoftwareComponent
      properties:
        version: '7.4.1'
        listen_address: 0.0.0.0
        elasticsearch_password: {get_input: elasticsearch_password}
        kibana_system_password: {get_input: kibana_system_password}
      dependencies:
        - VirtualMachine
      interfaces:
        Standard:
          inputs:
            - name: install
              description: Install Elasticsearch
            - name: configure
              description: Configure Elasticsearch
            - name: start
              description: Start Elasticsearch
          operations:
            install: |
              sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
              sudo yum install -y elasticsearch-7.4.1
            configure: |
              sudo tee -a /etc/elasticsearch/elasticsearch.yml << EOL
              xpack.security.enabled: true
              xpack.security.transport.ssl.enabled: false
              EOL
              sudo echo "elasticsearch.shutdown.allow_cluster_exit: false" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "xpack.monitoring.enabled: false" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "xpack.security.authc.api_key.enabled: true" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "xpack.security.authc.realms.native.realm1.order: 0" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "xpack.security.http.ssl.enabled: false" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "xpack.security.transport.ssl.enabled: false" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "network.host: 0.0.0.0" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "http.host: 0.0.0.0" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "discovery.seed_hosts: []" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "cluster.initial_master_nodes: ["nodename"]" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "elasticsearch.username: elastic" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "elasticsearch.password: ${elasticsearch_password}" >> /etc/elasticsearch/elasticsearch.yml
              sudo echo "kibana_system_password: ${kibana_system_password}" >> /etc/elasticsearch/elasticsearch.yml
            start: |
              sudo systemctl daemon-reload
              sudo systemctl enable elasticsearch
              sudo systemctl start elasticsearch

    Network:
      type: tosca.nodes.Network
      properties:
        name: public
        network_type: ipv4

  inputs:
    - name: elasticsearch_password
      type: string
      required: true
      sensitive: true

    - name: kibana_system_password
      type: string
      required: true
      sensitive: true

  outputs:
    public_address:
      value: {get_attribute: [VirtualMachine, public_address]}
    access_credentials:
      elastic_user: elastic
      elastic_password: {get_input: elasticsearch_password}
      kibana_system_user: system
      kibana_system_password: {get_input: kibana_system_password}
