
tosca_definitions_version: alien4cloud-1.3

topology_template:
  description: Web Server Deployment
  node_templates:
    web_server:
      type: tosca.nodes.Compute
      properties:
        os: linux
        os_version: ubuntu
        server_version: 2.4
      capabilities:
        bind:
          properties:
            port: 80
        health:
          check:
            method: GET
            path: /
            expected_status: 200
      artifacts:
        server_software:
          type: tosca.artifacts.Software
          version: 2.4
      interfaces:
        Standard:
          start: |
            sudo systemctl start webserver
          stop: |
            sudo systemctl stop webserver
          restart: |
            sudo systemctl restart webserver
      dependencies:
        - network

    network:
      type: tosca.nodes.Network
      properties:
        network_name: private_network
        protocol: tcp
        secure: true
      interfaces:
        Standard:
          configure: |
            sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
            sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT

    web_server_endpoint:
      type: tosca.nodes.Network
      properties:
        network_name: public_network
        protocol: http
        secure: false
      interfaces:
        Standard:
          expose: |
            sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT

  outputs:
    web_server_url:
      value: { get_attribute: [web_server_endpoint, url] }
    compute_instance_id:
      value: { get_attribute: [web_server, instance_id] }
