tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_constants: https://indigo-dc.github.io/tosca-types/1.0.0O1/indigo_types.yaml
  - tosca_types: tosca_types.yaml

topology_template:
  description: Galaxy Application Deployment

  input_parameters:
    cpus_num:
      type: integer
      default: 2
    memory_size:
      type: string
      default: 4 GB
    disk_space:
      type: string
      default: 50 GB
    storage_size:
      type: string
      default: 50 GB
    admin_email:
      type: string
    admin_api_key:
      type: string
    app_username:
      type: string
    app_version:
      type: string
      default: 22.05
    app_description:
      type: string
    ssh_public_key:
      type: string
    storage_path:
      type: string
      default: /data
    enable_encryption:
      type: boolean
      default: false
    vault_url:
      type: string
      constraints:
        - if: enable_encryption
    wrapping_token:
      type: string
      constraints:
        - if: enable_encryption
    secret_path:
      type: string
      constraints:
        - if: enable_encryption
    secret_key_name:
      type: string
      constraints:
        - if: enable_encryption
    tool_flavor:
      type: string
      default: default_flavor
    install_reference_data:
      type: boolean
      default: false

  node_templates:
    galaxy_vm:
      type: indigo.Compute
      properties:
        cpus: { get_input: cpus_num }
        memory: { get_input: memory_size }
        disk_size: { get_input: disk_space }
        public_key: { get_input: ssh_public_key }

    galaxy_storage:
      type: indigo.Volume
      properties:
        size: { get_input: storage_size }
      relationships:
        - type: indigo.AttachVolume
          target: galaxy_vm

    galaxy_application:
      type: indigo.Application.Galaxy
      properties:
        version: { get_input: app_version }
        admin_email: { get_input: admin_email }
        admin_api_key: { get_input: admin_api_key }
        username: { get_input: app_username }
        description: { get_input: app_description }
        storage_path: { get_input: storage_path }
        enable_encryption: { get_input: enable_encryption }
        vault_url: { get_input: vault_url }
        wrapping_token: { get_input: wrapping_token }
        secret_path: { get_input: secret_path }
        secret_key_name: { get_input: secret_key_name }
        tool_flavor: { get_input: tool_flavor }
        install_reference_data: { get_input: install_reference_data }

      relationships:
        - type: indigo.HostedOn
          target: galaxy_vm
        - type: indigo.MountedOn
          target: galaxy_storage

  outputs:
    endpoint_url:
      value: { get_attribute: [galaxy_vm, endpoint_url] }
    public_ip:
      value: { get_attribute: [galaxy_vm, public_ip] }
