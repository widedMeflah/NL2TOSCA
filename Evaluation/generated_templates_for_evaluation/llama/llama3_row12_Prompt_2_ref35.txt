topology_template:
  node_templates:
    galaxy_vm:
      type: tosca.nodes.Compute
      properties:
        num_cpus: { get_input: cpu }
        num_cpus_per_core: 1
        mem_size: { get_input: memory }
        disk_size: { get_input: disk_size }
      requirements:
        - network:
            node: galaxy_network
            relationship: tosca.relationships.Network
        - storage:
            node: galaxy_storage
            relationship: tosca.relationships.AttachedTo
      interfaces:
        Standard:
          configure:
            inputs:
              cpu: { get_input: cpu }
              memory: { get_input: memory }
              disk_size: { get_input: disk_size }
              galaxy_version: { get_input: galaxy_version }
              admin_email: { get_input: admin_email }
              api_key: { get_input: api_key }
              ssh_key: { get_input: ssh_key }
              data_path: { get_input: data_path }
              description: { get_input: description }
              encrypted: { get_input: encrypted }
              vault_server: { get_input: vault_server }
              install_ref_data: { get_input: install_ref_data }
              galaxy_flavor: { get_input: galaxy_flavor }
    galaxy_storage:
      type: tosca.nodes.Storage
      properties:
        size: { get_input: disk_size }
        encrypted: { get_input: encrypted }
      requirements:
        - vault:
            node: vault_server
            relationship: tosca.relationships.EncryptedBy
    galaxy_network:
      type: tosca.nodes.Network
    vault_server:
      type: tosca.nodes.Vault
      properties:
        addr: { get_input: vault_server }
      requirements:
        - storage:
            node: vault_storage
            relationship: tosca.relationships.AttachedTo
    vault_storage:
      type: tosca.nodes.Storage
  inputs:
    cpu:
      type: integer
      description: Number of CPUs
    memory:
      type: integer
      description: Amount of memory in MB
    disk_size:
      type: integer
      description: Size of disk in GB
      constraints:
        - greater_or_equal: 50
    galaxy_version:
      type: string
      description: Version of Galaxy to install
    admin_email:
      type: string
      description: Email of admin user
    api_key:
      type: string
      description: API key for admin user
    ssh_key:
      type: string
      description: Public SSH key for access
    data_path:
      type: string
      description: Directory path for storing Galaxy data
    description:
      type: string
      description: Description for the instance
    encrypted:
      type: boolean
      description: Whether storage should be encrypted
    vault_server:
      type: string
      description: Address of Vault server for encryption key management
    install_ref_data:
      type: boolean
      description: Whether to install reference data
    galaxy_flavor:
      type: string
      description: Flavor of Galaxy for tool installation