tosca_definitions_version: tosca_simple_yaml_1_3

description: Deployment environment for Alien4Cloud with ElasticSearch and IT Testing.

imports:
  - alien4cloud-stdlib:latest # Standard library containing common TOSCA types and A4C specific types if available.

node_types:
  org.alien4cloud.nodes.Alien4CloudApplication:
    derived_from: tosca.nodes.SoftwareComponent
    properties:
      context_root:
        type: string
        default: "/"
      profiles:
        type: list
        entry_schema: { type: string }
        default: []
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn
      - java_runtime:
          capability: tosca.capabilities.SoftwareComponent
          node: org.alien4cloud.nodes.OracleJDK
          relationship: tosca.relationships.DependsOn
      - elastic_search_connection_1:
          capability: org.alien4cloud.capabilities.ElasticSearchEndpoint
          node: org.alien4cloud.nodes.ElasticSearchInstance
          relationship: tosca.relationships.ConnectsTo
      - elastic_search_connection_2:
          capability: org.alien4cloud.capabilities.ElasticSearchEndpoint
          node: org.alien4cloud.nodes.ElasticSearchInstance
          relationship: tosca.relationships.ConnectsTo

  org.alien4cloud.nodes.ElasticSearchInstance:
    derived_from: tosca.nodes.SoftwareComponent
    properties:
      replication_enabled:
        type: boolean
        default: false
    capabilities:
      elastic_search_endpoint:
        type: org.alien4cloud.capabilities.ElasticSearchEndpoint
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn
      - java_runtime:
          capability: tosca.capabilities.SoftwareComponent
          node: org.alien4cloud.nodes.OracleJDK
          relationship: tosca.relationships.DependsOn

  org.alien4cloud.nodes.OracleJDK:
    derived_from: tosca.nodes.SoftwareComponent
    properties:
      download_url:
        type: string
        description: URL to download Oracle JDK installer.
      install_location:
        type: string
        default: /opt/java/jdk
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn

  org.alien4cloud.nodes.ITTestingComponent:
    derived_from: tosca.nodes.SoftwareComponent
    properties:
      plugin_branch:
        type: string
        default: master
      plugin_version:
        type: version
        default: 1.0.0
      test_suite:
        type: string
    requirements:
      - host:
          capability: tosca.capabilities.Container
          node: tosca.nodes.Compute
          relationship: tosca.relationships.HostedOn
      - java_runtime:
          capability: tosca.capabilities.SoftwareComponent
          node: org.alien4cloud.nodes.OracleJDK
          relationship: tosca.relationships.DependsOn
      - alien4cloud_app:
          capability: tosca.capabilities.Endpoint.Admin
          node: org.alien4cloud.nodes.Alien4CloudApplication
          relationship: tosca.relationships.ConnectsTo

capability_types:
  org.alien4cloud.capabilities.ElasticSearchEndpoint:
    derived_from: tosca.capabilities.Endpoint
    description: Capability to expose an ElasticSearch endpoint.

topology_template:
  node_templates:
    a4c_compute:
      type: tosca.nodes.Compute
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 1
        host:
          properties:
            num_cpus: 2
            mem_size: 4 GB
      requirements:
        - network:
            node: common_network
            capability: tosca.capabilities.Network
            relationship: tosca.relationships.ConnectsTo

    es_compute_1:
      type: tosca.nodes.Compute
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 1
        host:
          properties:
            num_cpus: 2
            mem_size: 4 GB
      requirements:
        - network:
            node: common_network
            capability: tosca.capabilities.Network
            relationship: tosca.relationships.ConnectsTo

    es_compute_2:
      type: tosca.nodes.Compute
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 1
        host:
          properties:
            num_cpus: 2
            mem_size: 4 GB
      requirements:
        - network:
            node: common_network
            capability: tosca.capabilities.Network
            relationship: tosca.relationships.ConnectsTo

    it_test_compute:
      type: tosca.nodes.Compute
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 1
        host:
          properties:
            num_cpus: 1
            mem_size: 2 GB
      requirements:
        - network:
            node: common_network
            capability: tosca.capabilities.Network
            relationship: tosca.relationships.ConnectsTo

    common_network:
      type: tosca.nodes.Network
      properties:
        ip_version: 4

    a4c_jdk:
      type: org.alien4cloud.nodes.OracleJDK
      properties:
        download_url: "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz"
        install_location: "/opt/jdk-oracle"
      requirements:
        - host: a4c_compute

    es1_jdk:
      type: org.alien4cloud.nodes.OracleJDK
      properties:
        download_url: "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz"
        install_location: "/opt/jdk-oracle"
      requirements:
        - host: es_compute_1

    es2_jdk:
      type: org.alien4cloud.nodes.OracleJDK
      properties:
        download_url: "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz"
        install_location: "/opt/jdk-oracle"
      requirements:
        - host: es_compute_2

    it_test_jdk:
      type: org.alien4cloud.nodes.OracleJDK
      properties:
        download_url: "https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz"
        install_location: "/opt/jdk-oracle"
      requirements:
        - host: it_test_compute

    alien4cloud_app:
      type: org.alien4cloud.nodes.Alien4CloudApplication
      properties:
        context_root: "/"
        profiles: [security-demo, noApiDoc]
      requirements:
        - host: a4c_compute
        - java_runtime: a4c_jdk
        - elastic_search_connection_1: elasticsearch_instance_1
        - elastic_search_connection_2: elasticsearch_instance_2

    elasticsearch_instance_1:
      type: org.alien4cloud.nodes.ElasticSearchInstance
      properties:
        replication_enabled: true
      requirements:
        - host: es_compute_1
        - java_runtime: es1_jdk

    elasticsearch_instance_2:
      type: org.alien4cloud.nodes.ElasticSearchInstance
      properties:
        replication_enabled: true
      requirements:
        - host: es_compute_2
        - java_runtime: es2_jdk

    it_testing:
      type: org.alien4cloud.nodes.ITTestingComponent
      properties:
        plugin_branch: develop
        plugin_version: 1.3.0-RC5
        test_suite: RunCloudify3AmazonLongRunIT
      requirements:
        - host: it_test_compute
        - java_runtime: it_test_jdk
        - alien4cloud_app: alien4cloud_app