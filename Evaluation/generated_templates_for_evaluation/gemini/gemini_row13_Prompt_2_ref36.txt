tosca_definitions_version: tosca_simple_yaml_1_3

description: TOSCA-compliant description for setting up a flexible computing environment with a main control unit, scalable worker units, a web interface, and dedicated data storage.

imports:
  - tosca_profiles/tosca_simple_yaml/1.3/tosca_simple_yaml_1_3_types.yaml

topology_template:
  inputs:
    main_control_unit_cpus:
      type: integer
      description: Number of CPUs for the main control unit.
      required: true
    main_control_unit_memory_gb:
      type: scalar-unit.size
      description: Memory size (in GB) for the main control unit.
      required: true
    worker_unit_cpus:
      type: integer
      description: Number of CPUs for each worker unit.
      required: true
    worker_unit_memory_gb:
      type: scalar-unit.size
      description: Memory size (in GB) for each worker unit.
      required: true
    max_worker_units:
      type: integer
      description: Maximum number of worker units allowed in the environment.
      required: true
      constraints:
        - greater_than: 0
    min_worker_units:
      type: integer
      description: Minimum number of worker units in the environment (can be 0 if desired).
      default: 0
      constraints:
        - greater_than_or_equal: 0
    hybrid_environment_enabled:
      type: boolean
      description: Set to true to enable hybrid environment operation.
      default: false
    hybrid_provider_type:
      type: string
      description: The type of cloud provider for hybrid environment (e.g., AWS, OpenStack, Azure). Required if hybrid_environment_enabled is true.
      required: { get_input: hybrid_environment_enabled }
    admin_email:
      type: string
      description: Admin email for logging into the web interface.
      required: true
      constraints:
        - pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
    api_key:
      type: string
      description: API key for web interface authentication.
      required: true
    web_interface_version:
      type: string
      description: Version of the web interface.
      required: true
    web_interface_description:
      type: string
      description: Description for the web interface.
      required: true
    ssh_public_key:
      type: string
      description: SSH public key for secure access to the web interface or system.
      required: true
    data_storage_size_gb:
      type: scalar-unit.size
      description: Size of the data storage (in GB) for system generated data.
      default: 100 GB
      constraints:
        - greater_than: 0 GB

  node_templates:
    main_control_unit:
      type: tosca.nodes.Compute
      properties:
        num_cpus: { get_input: main_control_unit_cpus }
        mem_size: { get_input: main_control_unit_memory_gb }
        os:
          architecture: x86_64
          type: linux
          distribution: ubuntu
          version: 20.04
        image: ubuntu-20.04-lts
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 1
        workload_management_support:
          properties:
            supported_managers:
              - Torque
              - SGE
              - Slurm
              - Condor
      artifacts:
        install_managers_script:
          file: scripts/install_workload_managers.sh
          type: tosca.artifacts.File

    worker_unit_group:
      type: tosca.nodes.Compute
      properties:
        num_cpus: { get_input: worker_unit_cpus }
        mem_size: { get_input: worker_unit_memory_gb }
        os:
          architecture: x86_64
          type: linux
          distribution: ubuntu
          version: 20.04
        image: ubuntu-20.04-lts
      capabilities:
        scalable:
          properties:
            min_instances: { get_input: min_worker_units }
            max_instances: { get_input: max_worker_units }
            default_instances: { get_input: min_worker_units }
      requirements:
        - host:
            node: main_control_unit
            relationship: tosca.relationships.DependsOn

    flexible_computing_web_interface:
      type: tosca.nodes.SoftwareComponent
      properties:
        component_version: { get_input: web_interface_version }
        component_description: { get_input: web_interface_description }
        admin_login_email: { get_input: admin_email }
        admin_login_api_key: { get_input: api_key }
        admin_ssh_key: { get_input: ssh_public_key }
      requirements:
        - host: main_control_unit
      artifacts:
        deploy_web_ui_script:
          file: scripts/deploy_web_ui.sh
          type: tosca.artifacts.File

    system_data_storage:
      type: tosca.nodes.BlockStorage
      properties:
        size: { get_input: data_storage_size_gb }
        description: Dedicated storage for system generated data.
      requirements:
        - attachment:
            node: main_control_unit
            relationship: tosca.relationships.AttachesTo

  outputs:
    system_public_url:
      description: The public URL to access the flexible computing environment's web interface or control unit.
      value: { get_attribute: [main_control_unit, public_address] }
    admin_credentials_info:
      description: Information about the admin login for the web interface.
      value:
        email: { get_attribute: [flexible_computing_web_interface, admin_login_email] }
        api_key: { get_attribute: [flexible_computing_web_interface, admin_login_api_key] }
        ssh_public_key_used: { get_attribute: [flexible_computing_web_interface, admin_ssh_key] }
