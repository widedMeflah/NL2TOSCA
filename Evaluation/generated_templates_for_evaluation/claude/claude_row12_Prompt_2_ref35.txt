tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: Galaxy deployment on a VM with custom configuration

topology_template:
  inputs:
    cpu_count:
      type: integer
      description: Number of CPUs
      default: 4
      required: true

    memory_size:
      type: scalar-unit.size
      description: RAM memory size
      default: 8 GB
      required: true

    storage_size:
      type: scalar-unit.size
      description: Storage size
      default: 50 GB
      required: true

    admin_email:
      type: string
      description: Galaxy admin email
      required: true

    admin_api_key:
      type: string
      description: Galaxy admin API key
      required: true

    galaxy_version:
      type: string
      description: Galaxy version to install
      default: release_22.05
      required: true

    instance_description:
      type: string
      description: Description of the Galaxy instance
      required: true

    public_ssh_key:
      type: string
      description: SSH public key
      required: true

    galaxy_data_dir:
      type: string
      description: Directory path for Galaxy data
      default: /data/galaxy
      required: true

    encrypt_storage:
      type: boolean
      description: Enable storage encryption
      default: false

    vault_url:
      type: string
      description: Vault server URL
      required: false

    vault_token:
      type: string
      description: Vault authentication token
      required: false

    install_reference_data:
      type: boolean
      description: Install reference data
      default: false

    galaxy_flavor:
      type: string
      description: Galaxy flavor for tool installation
      default: "minimal"
      required: true

  node_templates:
    galaxy:
      type: tosca.nodes.indigo.GalaxyPortal
      properties:
        admin_email: { get_input: admin_email }
        admin_api_key: { get_input: admin_api_key }
        version: { get_input: galaxy_version }
        instance_description: { get_input: instance_description }
        install_reference_data: { get_input: install_reference_data }
        galaxy_flavor: { get_input: galaxy_flavor }
        galaxy_data_dir: { get_input: galaxy_data_dir }

      requirements:
        - host: galaxy_server

    galaxy_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        host:
          properties:
            num_cpus: { get_input: cpu_count }
            mem_size: { get_input: memory_size }
        os:
          properties:
            type: linux
        endpoint:
          properties:
            network_name: PUBLIC
            ports: 
              http_port:
                protocol: tcp
                source: 80
            credentials:
              user: galaxy
              token: { get_input: public_ssh_key }

    galaxy_storage:
      type: tosca.nodes.BlockStorage
      properties:
        size: { get_input: storage_size }
        encrypted: { get_input: encrypt_storage }
        vault_url: { get_input: vault_url }
        vault_token: { get_input: vault_token }
      requirements:
        - attachment: galaxy_server