tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: TOSCA template for deploying Galaxy

topology_template:
  inputs:
    num_cpus:
      type: integer
      description: Number of CPUs for the VM
      default: 2
      required: false
    memory_size:
      type: scalar-unit.size
      description: Amount of memory for the VM
      default: 4 GB
      required: false
    storage_size:
      type: scalar-unit.size
      description: Amount of storage for Galaxy
      default: 50 GB
      required: false
    admin_email:
      type: string
      description: Admin user email
      required: true
    admin_api_key:
      type: string
      description: Admin API key
      required: true
    user_name:
      type: string
      description: Username to run Galaxy
      required: true
    galaxy_version:
      type: string
      description: Galaxy version
      default: release_22.05
      required: false
    instance_description:
      type: string
      description: Description of this Galaxy instance
      required: true
    ssh_public_key:
      type: string
      description: SSH public key
      required: true
    data_path:
      type: string
      description: Path to store Galaxy data
      default: /data
      required: false
    enable_storage_encryption:
      type: boolean
      description: Enable storage encryption
      default: false
      required: false
    vault_url:
      type: string
      description: Vault server URL
      required: false
    vault_wrapping_token:
      type: string
      description: Vault wrapping token
      required: false
    vault_secret_path:
      type: string
      description: Path to secret in Vault
      required: false
    vault_secret_key:
      type: string
      description: Name of secret key in Vault
      required: false
    flavor:
      type: string
      description: Galaxy flavor for tool installation
      default: "minimal"
      required: false
    install_reference_data:
      type: boolean
      description: Install reference data
      default: false
      required: false

  node_templates:
    galaxy:
      type: tosca.nodes.indigo.Galaxy
      properties:
        admin_email: { get_input: admin_email }
        admin_api_key: { get_input: admin_api_key }
        user_name: { get_input: user_name }
        version: { get_input: galaxy_version }
        instance_description: { get_input: instance_description }
        flavor: { get_input: flavor }
        install_reference_data: { get_input: install_reference_data }
      requirements:
        - host: galaxy_server

    galaxy_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        host:
          properties:
            num_cpus: { get_input: num_cpus }
            mem_size: { get_input: memory_size }
        os:
          properties:
            type: linux
      requirements:
        - local_storage:
            node: galaxy_storage
            relationship: tosca.relationships.AttachesTo

    galaxy_storage:
      type: tosca.nodes.BlockStorage
      properties:
        size: { get_input: storage_size }
        location: { get_input: data_path }
        encrypted: { get_input: enable_storage_encryption }
        vault_url: { get_input: vault_url }
        vault_wrapping_token: { get_input: vault_wrapping_token }
        vault_secret_path: { get_input: vault_secret_path }
        vault_secret_key: { get_input: vault_secret_key }

  outputs:
    galaxy_url:
      value: { concat: ['http://', get_attribute: [ galaxy_server, public_address ], '/galaxy/'] }
    instance_ip:
      value: { get_attribute: [ galaxy_server, public_address ] }