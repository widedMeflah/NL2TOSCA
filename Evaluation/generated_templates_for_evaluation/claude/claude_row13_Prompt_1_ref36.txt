tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: TOSCA template for deploying an auto-scaling compute cluster

topology_template:
  inputs:
    admin_email:
      type: string
      description: Administrator email
      required: true
    
    api_key:
      type: string
      description: API key for authentication
      required: true
    
    ssh_pub_key:
      type: string
      description: SSH public key
      required: true
    
    software_version:
      type: string
      default: "latest"
    
    max_worker_nodes:
      type: integer
      default: 10
      
    system_description:
      type: string
      default: "Auto-scaling compute cluster"

  node_templates:
    management_node:
      type: tosca.nodes.indigo.Compute
      capabilities:
        host:
          properties:
            num_cpus: 4
            mem_size: 8 GB
        os:
          properties:
            type: linux
            
    worker_node:
      type: tosca.nodes.indigo.Compute
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: { get_input: max_worker_nodes }
            default_instances: 2
        host:
          properties:
            num_cpus: 2
            mem_size: 4 GB
        os:
          properties:
            type: linux
            
    web_interface:
      type: tosca.nodes.WebServer
      properties:
        admin_credential:
          user: admin
          token: { get_input: api_key }
        admin_email: { get_input: admin_email }
        software_version: { get_input: software_version }
        
    storage:
      type: tosca.nodes.BlockStorage
      properties:
        size: 100 GB
        
  outputs:
    web_interface_url:
      value: { get_attribute: [ web_interface, url ] }
    cluster_ip:
      value: { get_attribute: [ management_node, public_address ] }
    admin_credentials:
      value: { get_attribute: [ web_interface, admin_credential ] }