tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: TOSCA template for deploying Elasticsearch service

topology_template:
  inputs:
    es_version:
      type: string
      default: "7.4.1"
      description: Elasticsearch version
    elastic_password:
      type: string
      required: true
      description: Password for elastic user
    kibana_password:
      type: string
      required: true
      description: Password for kibana system user
    cpus:
      type: integer
      default: 2
      constraints:
        - valid_values: [ 2, 4 ]
    mem:
      type: scalar-unit.size
      default: 4 GB
      constraints:
        - valid_values: [ 4 GB, 8 GB ]

  node_templates:
    elasticsearch:
      type: tosca.nodes.indigo.Elasticsearch
      properties:
        es_version: { get_input: es_version }
        elastic_password: { get_input: elastic_password }
        kibana_password: { get_input: kibana_password }
        bind_address: "0.0.0.0"
      requirements:
        - host: elastic_server

    elastic_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        host:
          properties:
            num_cpus: { get_input: cpus }
            mem_size: { get_input: mem }
        os:
          properties:
            type: linux
            distribution: ubuntu
            version: "16.04"
        endpoint:
          properties:
            network_name: PUBLIC
            ports:
              elasticsearch_port:
                protocol: tcp
                source: 9200

  outputs:
    elasticsearch_endpoint:
      value: { concat: ['http://', get_attribute: [elastic_server, public_address], ':9200'] }
    public_ip:
      value: { get_attribute: [elastic_server, public_address] }
    elastic_user:
      value: "elastic"
    elastic_password:
      value: { get_input: elastic_password }