tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: TOSCA template for deploying a Wine Cellar web application with MySQL database

topology_template:
  inputs:
    mysql_root_password:
      type: string
      description: Root password for MySQL
      required: true
    mysql_user:
      type: string
      description: MySQL user for the application
      default: wineapp
    mysql_password:
      type: string
      description: MySQL password for the application user
      required: true
    mysql_database:
      type: string
      description: Database name for the application
      default: winecellar

  node_templates:
    web_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        endpoint:
          properties:
            network_name: PUBLIC
            ports:
              http_port:
                protocol: tcp
                source: 80
              https_port:
                protocol: tcp
                source: 443
        host:
          properties:
            num_cpus: 2
            mem_size: 2 GB
        os:
          properties:
            type: linux
            distribution: ubuntu
            version: 20.04

    apache:
      type: tosca.nodes.WebServer.Apache
      requirements:
        - host: web_server

    wine_app:
      type: tosca.nodes.SoftwareComponent
      requirements:
        - host: apache
        - database_endpoint: mysql_database
      interfaces:
        Standard:
          create:
            implementation: scripts/install_app.sh
          configure:
            implementation: scripts/configure_app.sh
      artifacts:
        app_code:
          file: https://example.com/wine-cellar-app.tar.gz
          type: tosca.artifacts.File

    database_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        endpoint:
          properties:
            network_name: PRIVATE
        host:
          properties:
            num_cpus: 2
            mem_size: 4 GB
        os:
          properties:
            type: linux
            distribution: ubuntu
            version: 20.04

    mysql_database:
      type: tosca.nodes.Database.MySQL
      properties:
        name: { get_input: mysql_database }
        user: { get_input: mysql_user }
        password: { get_input: mysql_password }
        root_password: { get_input: mysql_root_password }
      requirements:
        - host: database_server

  outputs:
    website_url:
      description: URL of the deployed application
      value: { concat: ['http://', get_attribute: [web_server, public_address]] }