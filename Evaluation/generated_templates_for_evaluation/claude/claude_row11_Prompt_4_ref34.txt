tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/master/custom_types.yaml

description: Galaxy deployment with cluster support on CentOS 7

topology_template:
  inputs:
    num_worker_nodes:
      type: integer
      description: Number of worker nodes
      default: 2
      required: true
    
    admin_email:
      type: string
      description: Admin email for notifications
      required: true
    
    vault_url:
      type: string
      description: URL of the Vault server
      required: true
    
    vault_token:
      type: string
      description: Token for Vault authentication
      required: true

  node_templates:
    galaxy_portal:
      type: tosca.nodes.indigo.GalaxyPortal
      properties:
        admin_email: { get_input: admin_email }
        version: 22.05
        flavor: computational
        reference_data: true
        storage_encryption: true
      requirements:
        - host: galaxy_server

    galaxy_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        host:
          properties:
            num_cpus: 4
            mem_size: 8 GB
        os:
          properties:
            type: linux
            distribution: centos
            version: 7

    slurm_server:
      type: tosca.nodes.indigo.SLURM.Server
      properties:
        wn_ips: { get_attribute: [ galaxy_wn, private_address ] }
      requirements:
        - host: galaxy_server

    galaxy_wn:
      type: tosca.nodes.indigo.SLURM.WorkerNode
      properties:
        front_end_ip: { get_attribute: [ galaxy_server, private_address ] }
      capabilities:
        wn:
          properties:
            max_instances: { get_input: num_worker_nodes }
            min_instances: 1
      requirements:
        - host: galaxy_wn_server

    galaxy_wn_server:
      type: tosca.nodes.indigo.Compute
      capabilities:
        host:
          properties:
            num_cpus: 2
            mem_size: 4 GB
        os:
          properties:
            type: linux
            distribution: centos
            version: 7

    vault_client:
      type: tosca.nodes.indigo.VaultClient
      properties:
        vault_url: { get_input: vault_url }
        vault_token: { get_input: vault_token }
      requirements:
        - host: galaxy_server

  outputs:
    galaxy_url:
      value: { concat: [ 'http://', get_attribute: [ galaxy_server, public_address ], '/galaxy' ] }
    cluster_frontend_ip:
      value: { get_attribute: [ galaxy_server, public_address ] }
    cluster_wn_ips:
      value: { get_attribute: [ galaxy_wn, public_address ] }